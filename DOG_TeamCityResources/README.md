# DOG_TeamCityResources
This module contains the following DSC resources for installing and configuring TeamCity build agents:

## cTeamCityBuildAgent

This resource handles both the installation of a TeamCity build agent, and the configuration of its buildAgent.properties file.

_Note: The TeamCity build agent requires Java.  The JRE must be installed, with the path to java.exe on the Path environment variable, before the agent will work.  If you're running the build agent on the same server as the TeamCity server, a JRE is already included, but you still have to set up the Path environnment variable._

Syntax:
```
cTeamCityBuildAgent [String] #ResourceName
{
    InstallPath       = [string]
    TeamCityServerUrl = [string]
    [Address          = [string]]
    [BuildProperties  = [hashtable]]
    [Ensure           = [string]{ Absent | Present }]
    [Name             = [string]]
    [Port             = [UInt32]]
    [SystemDirectory  = [string]]
    [TempDirectory    = [string]]
    [WorkDirectory    = [string]]
}
```

For parameter descriptions which refer to properties in the buildAgent.properties file, refer to https://confluence.jetbrains.com/display/TCD65/Build+Agent+Configuration for a detailed description of what each of these settings does.

- **InstallPath**: The folder where the TeamCity build agent should be installed.
- **TeamCityServerUrl**: The HTTP or HTTPS url of the TeamCity server that will use this build agent.  This URL is used both for registration / configuration of the build agent, and for obtaining the installation package.
- **Address**: The value to assign to the "ownAddress" property in the buildAgent.properties file.  By default, this value is not set, and the ownAddress property in the properties file is commented out.
- **Ensure**: The standard Present | Absent property on DSC resources.  A default value if Present is assumed.
- **Name**: The name to assign to this build agent, which will be displayed via the TeamCity server's web interface.  By default, this name is auto-generated by the server.
- **Port**: The TCP port on which the build agent should listen for HTTP connections from the TeamCity server.  By default, this is 9090.
- **SystemDirectory**: The value to assign to the systemDir property in buildAgent.properties.  By default, this is set to "../system" (which is relative to the configuration file; the system folder will exist as a child directory of InstallPath.)
- **TempDirectory**: The value to assign to the tempDir property in buildAgent.properties.  By default, this is set to "../temp" (which is relative to the configuration file; the temp folder will exist as a child directory of InstallPath.)
- **WorkDirectory**: The value to assign to the workDir property in buildAgent.properties.  By default, this is set to "../work" (which is relative to the configuration file; the work folder will exist as a child directory of InstallPath.)
- **BuildProperties**: Any custom build properties that you want to place in the buildAgent.properties file may be passed in via this hashtable parameter to the DSC resource.  The keys in this hashtable should begin with either "system." or "env.", and are described in more detail at https://confluence.jetbrains.com/display/TCD65/Configuring+Build+Parameters

## cTeamCityBuildAgentServiceConfigFile

This resource handles management of the wrapper.conf file used if you want to run a TeamCity build agent as a Windows service.

Syntax:
```
cTeamCityBuildAgentServiceConfigFile [String] #ResourceName
{
    InstallPath  = [string]
    [Description = [string]]
    [DisplayName = [string]]
    [Ensure      = [string]{ Absent | Present }]
    [Name        = [string]]
}
```

- **InstallPath**: The same folder assigned to the InstallPath of the corresponding cTeamCityBuildAgent resource.
- **Description**: The value to assign to the service's Description.
- **DisplayName**: The value to assign to the service's DisplayName.
- **Name**: The Name of the service.
- **Ensure**: The standard Present | Absent property for DSC resources.  Present by default.

## cTeamCityBuildAgentAndService

A composite resource which provides the most convenient way to install a build agent and run it as a Windows service.  This composes the following resources for you:

- **cTeamCityBuildAgent**: To install and configure the agent itself.
- **cTeamCityBuildAgentServiceConfigFile**: To configure the wrapper.conf file used by the build agent service launcher.
- **cService**: To create the Windows service itself, and ensure that it's running.
- **cFirewall**: To open a Windows Firewall rule for incoming connections to the agent's TCP port.

_Note:  Using this composite resource requires the cPSDesiredStateConfiguration and cNetworking modules from PowerShell.org:  https://github.com/PowerShellOrg/cPSDesiredStateConfiguration , https://github.com/PowerShellOrg/cNetworking_

Syntax:
```
cTeamCityBuildAgentAndService [String] #ResourceName
{
    InstallPath            = [String]
    TeamCityServerUrl      = [String]
    [Ensure                = [String]]
    [Name                  = [String]]
    [Address               = [String]]
    [Port                  = [UInt32]]
    [BuildProperties       = [Hashtable]]
    [ServiceName           = [String]]
    [ServiceDisplayName    = [String]]
    [ServiceDescription    = [String]]
    [ServiceBuiltInAccount  = [String]{ LocalSystem | LocalService | NetworkService }]
    [ServiceCredential     = [PSCredential]]
}
```

- **InstallPath**: The value passed to the InstallPath properties of both cTeamCityBuildAgent and cTeamCityBuildAgentServiceConfigFile.  Also used to generate the path to the cService binary.
- **TeamCityServerUrl**: The value passed to the TeamCityServerUrl property of cTeamCityBuildAgent.
- **Ensure**: The standard Present | Absent property for DSC resources.  Present by default.
- **Name**: The value passed to the Name property of cTeamCityBuildAgent.
- **Address**: The value passed to the Address property of cTeamCityBuildAgent.
- **Port**: The TCP port value used for both cTeamCityBuildAgent, and cFirewall.  9090 by default.
- **BuildProperties**: The value passed to the BuildProperties property of cTeamCityBuildAgent.
- **ServiceName**: The value passed to the Name property of cService and cTeamCityBuildAgentServiceConfigFile.  Defaults to 'TCBuildAgent'
- **ServiceDisplayName**: The value passed to the DisplayName property of cService and cTeamCityBuildAgentServiceConfigFile.  Defaults to 'TeamCity Build Agent'
- **ServiceDescription**: The value passed to the Description property of cService and cTeamCityBuildAgentServiceConfigFile.  Defaults to 'TeamCity Build Agent Service'
- **ServiceBuiltInAccount**: The value passed to the BuiltInAccount property of cService.  May be set to 'LocalSystem', 'LocalService', or 'NetworkService'.
- **ServiceCredential**: The value passed to the Credential property of cService.

_Note:  If neither ServiceBuiltInAccount or ServiceCredential are specified, the service will run as LocalSystem by default._

## Example

```posh
configuration Example
{
    Import-DscResource -ModuleName DOG_TeamCityResources

    node localhost
    {
        cTeamCityBuildAgentAndService Agent01
        {
            TeamCityServerUrl  = 'http://teamcityserver.local:8080'
            InstallPath        = 'C:\TeamCity\Agent01'
        }        

        cTeamCityBuildAgentAndService Agent02
        {
            TeamCityServerUrl  = 'http://teamcityserver.local:8080'
            InstallPath        = 'C:\TeamCity\Agent02'
            Port               = 9091
            Name               = 'Build Agent 2'
            ServiceName        = 'TCBuildAgent02'
            ServiceDisplayName = 'TeamCity Build Agent 2'
        }
    }
}
```

This sets up two build agents on the local computer.  Both are registered to the same TeamCity server.  Agent01 uses the default settings for port, agent and service name, etc, while Agent02 passes in custom values for these settings.  Both services will run as LocalSystem.
